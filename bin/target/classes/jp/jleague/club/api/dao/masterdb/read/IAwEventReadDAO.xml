<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.jleague.club.api.dao.masterdb.read.IAwEventReadDAO">

	<resultMap type="jp.jleague.club.api.dao.masterdb.dto.IAwEventDTO" id="dto">
		<result column="awards_event_id" property="awardsEventId" javaType="java.lang.Integer" />
		<result column="applicant_section_type" property="applicantSectionType" javaType="java.lang.String" />
		<result column="year" property="year" javaType="java.lang.Integer" />
		<result column="event_datetime" property="eventDatetime" javaType="java.util.Date" />
		<result column="banner_disp_start_datetime" property="bannerDispStartDatetime" javaType="java.util.Date" />
		<result column="banner_disp_end_datetime" property="bannerDispEndDatetime" javaType="java.util.Date" />
		<result column="banner_img_url" property="bannerImgUrl" javaType="java.lang.String" />
		<result column="receptionist_start_datetime" property="receptionistStartDatetime" javaType="java.util.Date" />
		<result column="receptionist_end_datetime" property="receptionistEndDatetime" javaType="java.util.Date" />
		<result column="regist_datetime" property="registDatetime" javaType="java.util.Date" />
		<result column="update_datetime" property="updateDatetime" javaType="java.util.Date" />
		<result column="applicant_winning_flg" property="applicantWinningFlg" javaType="java.lang.Integer" />
	</resultMap>

	<select id="selectPeriodKindNow" parameterType="java.util.Map" resultType="java.lang.Integer" >
	
		select
			1
		from i_aw_event
		where applicant_section_type = #{sectionPrimary}
		and year = #{year}
		and receptionist_start_datetime > #{now}
		
		union all
		
		select
			2
		from i_aw_event
		where applicant_section_type = #{sectionPrimary}
		and year = #{year}
		and receptionist_start_datetime <![CDATA[<=]]> #{now}
		and receptionist_end_datetime >= #{now}
		
		union all
		
		select
			3
		from (
			select
				i_aw_event.year
			from i_aw_event
			where (applicant_section_type = #{sectionPrimary}
				   and year = #{year}
				   and receptionist_end_datetime <![CDATA[<]]> #{now})
			or (applicant_section_type = #{sectionSecondary}
				and year = #{year}
				and receptionist_start_datetime > #{now})
			) t1
		group by t1.year
		having count(t1.year) = 2
		
		union all
		
		select
			4
		from i_aw_event
		where applicant_section_type = #{sectionSecondary}
		and year = #{year}
		and receptionist_start_datetime <![CDATA[<=]]> #{now}
		and receptionist_end_datetime >= #{now}
		
		union all

		select
			5
		from i_aw_event
		where applicant_section_type = #{sectionSecondary}
		and year = #{year}
		and receptionist_end_datetime <![CDATA[<]]> #{now}

	</select>

	<select id="selectEntryStatusMemberNow" resultMap="dto" parameterType="java.util.Map">
		select
			  ev.awards_event_id
			, ev.applicant_section_type
			, ev.year
			, ev.event_datetime
			, ev.banner_disp_start_datetime
			, ev.banner_disp_end_datetime
			, ev.banner_img_url
			, ev.receptionist_start_datetime
			, ev.receptionist_end_datetime
			, ev.regist_datetime
			, ev.update_datetime
			, app.applicant_winning_flg
		from i_aw_event ev
		inner join i_aw_applicant app
		on ev.awards_event_id = app.awards_event_id
		where app.member_id = #{memberId}
		order by app.applicant_datetime desc
		limit 1
	</select>
	
	<select id="selectOneByBannerDispDateNow" resultMap="dto" parameterType="java.util.Map">
		select
			  ev.awards_event_id
			, ev.applicant_section_type
			, ev.year
			, ev.event_datetime
			, ev.banner_disp_start_datetime
			, ev.banner_disp_end_datetime
			, ev.banner_img_url
			, ev.receptionist_start_datetime
			, ev.receptionist_end_datetime
			, ev.regist_datetime
			, ev.update_datetime
		from i_aw_event ev
		where ev.banner_disp_start_datetime <![CDATA[<=]]> #{now}
		and ev.banner_disp_end_datetime >= #{now}
	</select>

</mapper>
