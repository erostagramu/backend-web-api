<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.jleague.club.api.dao.masterdb.read.IAwTicketReadDAO">

	<resultMap type="jp.jleague.club.api.dao.masterdb.dto.IAwTicketDTO" id="dto">
		<result column="awards_ticket_id" property="awardsTicketId" javaType="java.lang.Integer" />
		<result column="awards_event_id" property="awardsEventId" javaType="java.lang.Integer" />
		<result column="club_id" property="clubId" javaType="java.lang.String" />
		<result column="seat_type" property="seatType" javaType="java.lang.String" />
		<result column="serial_id" property="serialId" javaType="java.lang.String" />
		<result column="regist_datetime" property="registDatetime" javaType="java.util.Date" />
		<result column="update_datetime" property="updateDatetime" javaType="java.util.Date" />
	</resultMap>

	<select id="selectOneNoUseAwTicket" resultMap="dto" parameterType="java.util.Map">
		select
			  ti.awards_ticket_id
			, ti.awards_event_id
			, ti.club_id
			, ti.seat_type
			, ti.serial_id
			, ti.regist_datetime
			, ti.update_datetime
		from i_aw_ticket ti
		inner join i_aw_event ev
		on ti.awards_event_id = ev.awards_event_id
		left join
		
		(
			select
				ti.awards_ticket_id
			from i_aw_ticket ti
			inner join i_aw_event ev
			on ev.awards_event_id = ti.awards_event_id
			inner join i_aw_applicant ap
			on ap.awards_event_id = ti.awards_event_id
			and ap.awards_ticket_id = ti.awards_ticket_id
			where ev.applicant_section_type = #{sectionType}
			and ap.applicant_winning_flg = 1
			and ti.seat_type = #{seatType}
			<if test="clubIdConditions != null">
			and ti.club_id = #{clubId}
			</if>
		) winner
		
		on ti.awards_ticket_id = winner.awards_ticket_id
		where winner.awards_ticket_id is null
		and ev.applicant_section_type = #{sectionType}
		and ti.seat_type = #{seatType}
		<if test="clubIdConditions != null">
		and ti.club_id = #{clubId}
		</if>
		limit 1
	</select>

</mapper>