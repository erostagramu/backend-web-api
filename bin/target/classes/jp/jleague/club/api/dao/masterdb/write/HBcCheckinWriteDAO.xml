<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.jleague.club.api.dao.masterdb.write.HBcCheckinWriteDAO">

	<resultMap type="jp.jleague.club.api.dao.masterdb.dto.HBcCheckinDTO" id="HBcCheckinDTO">
		<result column="checkin_history_serial_number" property="checkinHistorySerialNumber" javaType="java.lang.Integer" />
		<result column="medal_kind_id" property="medalKindId" javaType="java.lang.Integer" />
		<result column="member_id" property="memberId" javaType="java.lang.String" />
		<result column="acquisition_medal_num" property="acquisitionMedalNum" javaType="java.lang.Integer" />
		<result column="game_id" property="gameId" javaType="java.lang.String" />
		<result column="support_club_id" property="supportClubId" javaType="java.lang.String" />
		<result column="win_or_lose_flg" property="winOrLoseFlg" javaType="java.lang.Integer" />
		<result column="venue_code" property="venueCode" javaType="java.lang.String" />
		<result column="aeon_store_id" property="aeonStoreId" javaType="java.lang.String" />
		<result column="longitude" property="longitude" javaType="java.lang.String" />
		<result column="latitude" property="latitude" javaType="java.lang.String" />
		<result column="checkin_completion_flg" property="checkinCompletionFlg" javaType="java.lang.Integer" />
		<result column="regist_datetime" property="registDatetime" javaType="java.util.Date" />
	</resultMap>

	<select id="selectStudiumCIOrderByRegistDateLimit1" parameterType="jp.jleague.club.api.dao.masterdb.dto.HBcCheckinDTO" resultType="int">
		select checkin_history_serial_number
		from h_bc_checkin
		where member_id = #{memberId}
		  and medal_kind_id = #{medalKindId}
		order by regist_datetime desc
		limit 1
	</select>

	<select id="selectCIListOrderByGameDateAndGameStartDateTime" parameterType="jp.jleague.club.api.dao.masterdb.dto.HBcCheckinDTO" resultMap="HBcCheckinDTO">
		select
			chk.checkin_history_serial_number,
			chk.medal_kind_id,
			chk.member_id,
			chk.acquisition_medal_num,
			chk.game_id,
			chk.support_club_id,
			chk.win_or_lose_flg,
			chk.venue_code,
			chk.aeon_store_id,
			chk.longitude,
			chk.latitude,
			chk.checkin_completion_flg,
			chk.regist_datetime
		from h_bc_checkin chk
		<if test="medalKindId != 1200">
			 ,i_gm_schedule sch
		</if>
		where chk.member_id = #{memberId}
		  and chk.medal_kind_id = #{medalKindId}
		<if test="medalKindId != 1200">
		  and chk.game_id = sch.game_id
		ORDER BY sch.game_start_datetime desc
		</if>
		<if test="medalKindId == 1200">
		ORDER BY chk.regist_datetime desc
		</if>
	</select>

	<delete id="deleteOldApologyCheckin" parameterType="int">
		delete from h_bc_checkin
		where checkin_history_serial_number = #{checkinHistorySerialNumber}
	</delete>

	<insert id="insertHBcCheckin" parameterType="jp.jleague.club.api.dao.masterdb.dto.HBcCheckinDTO">
		insert into h_bc_checkin
			(
			 medal_kind_id,
			 member_id,
			 acquisition_medal_num,
			 game_id,
			 support_club_id,
			 win_or_lose_flg,
			 venue_code,
			 longitude,
			 latitude,
			 checkin_completion_flg,
			 regist_datetime)
		values
			(
			 #{medalKindId},
			 #{memberId},
			 #{acquisitionMedalNum},
			 #{gameId},
			 #{supportClubId},
			 #{winOrLoseFlg},
			 #{venueCode},
			 #{longitude},
			 #{latitude},
			 #{checkinCompletionFlg},
			 #{registDatetime})
	</insert>

	<insert id="insertAeonCheckinTosen" parameterType="jp.jleague.club.api.dao.masterdb.dto.HBcCheckinDTO">
		insert into h_bc_checkin
			(
			 medal_kind_id,
			 member_id,
			 acquisition_medal_num,
			 aeon_store_id,
			 longitude,
			 latitude,
			 regist_datetime)
		values
			(
			 #{medalKindId},
			 #{memberId},
			 #{acquisitionMedalNum},
			 #{aeonStoreId},
			 #{longitude},
			 #{latitude},
			 #{registDatetime})
	</insert>

	<select id="selectMaxCheckinHistorySerialNumber" resultType="java.lang.Integer">
		select case when max(checkin_history_serial_number) is null then 0
					else max(checkin_history_serial_number) end
		  from h_bc_checkin
	</select>
</mapper>