<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.jleague.club.api.dao.masterdb.read.INewsReadDAO">

	<resultMap type="jp.jleague.club.api.dao.masterdb.dto.INewsDTO" id="INewsDTO">
		<result column="integrated_article_id" property="integratedArticleId" javaType="java.lang.Integer" />
		<result column="provider_id" property="providerId" javaType="java.lang.Integer" />
		<result column="article_id" property="articleId" javaType="java.lang.Integer" />
		<result column="article_title" property="articleTitle" javaType="java.lang.String" />
		<result column="article_release_datetime" property="articleReleaseDatetime" javaType="java.util.Date" />
		<result column="img_url" property="imgUrl" javaType="java.lang.String" />
		<result column="movie_url" property="movieUrl" javaType="java.lang.String" />
		<result column="movie_thumbnail_url" property="movieThumbnailUrl" javaType="java.lang.String" />
		<result column="details_screen_url" property="detailsScreenUrl" javaType="java.lang.String" />
		<result column="game_kind_id" property="gameKindId" javaType="java.lang.Integer" />
		<result column="game_id" property="gameId" javaType="java.lang.String" />
		<result column="regist_datetime" property="registDatetime" javaType="java.util.Date" />
		<result column="update_datetime" property="updateDatetime" javaType="java.util.Date" />
	</resultMap>

	<sql id="newsAllWhere">
		where article_release_datetime <![CDATA[<=]]> #{currentDate}
		<if test="addLoadFlg == true">
			and article_release_datetime <![CDATA[<=]]> #{lastArticleReleaseDate}
		</if>
		order by article_release_datetime desc, integrated_article_id desc
		<if test="limit != null">
		    limit #{limit}
		</if>
	</sql>

	<sql id="newsClubsWhere">
		where nt.club_id = #{clubId}
		  and article_release_datetime <![CDATA[<=]]> #{currentDate}
		<if test="addLoadFlg == true">
			and article_release_datetime <![CDATA[<=]]> #{lastArticleReleaseDate}
		</if>
		order by article_release_datetime desc, ns.integrated_article_id desc
		<if test="limit != null">
		    limit #{limit}
		</if>
	</sql>

	<select id="selectNewsListCount" parameterType="Map" resultType="java.lang.Integer">
		select
			count(integrated_article_id)
		from i_news
		<include refid="newsAllWhere" />
	</select>

	<select id="selectNewsList" parameterType="Map" resultMap="INewsDTO">
		select
			   integrated_article_id,
			   provider_id,
			   article_id,
			   article_title,
			   article_release_datetime,
			   img_url,
			   movie_url,
			   movie_thumbnail_url,
			   details_screen_url,
			   game_kind_id,
			   game_id,
			   regist_datetime,
			   update_datetime
		from i_news
		<include refid="newsAllWhere" />
	</select>

	<select id="selectNewsListByClubIdCount" parameterType="Map" resultType="java.lang.Integer">
		select
			count(ns.integrated_article_id)
		from i_news ns
		inner join i_news_club_tying nt on ns.integrated_article_id = nt.integrated_article_id
		<include refid="newsClubsWhere" />
	</select>

	<select id="selectNewsListByClubId" parameterType="Map" resultMap="INewsDTO">
		select
			   ns.integrated_article_id,
			   provider_id,
			   article_id,
			   article_title,
			   article_release_datetime,
			   img_url,
			   movie_url,
			   movie_thumbnail_url,
			   details_screen_url,
			   game_kind_id,
			   game_id,
			   ns.regist_datetime,
			   ns.update_datetime
		from i_news ns
		inner join i_news_club_tying nt on ns.integrated_article_id = nt.integrated_article_id
		<include refid="newsClubsWhere" />
	</select>

	<select id="selectLastArticleReleaseDate" parameterType="java.lang.Integer" resultType="java.util.Date">
		select article_release_datetime
		from i_news
		where integrated_article_id = #{lastArticleId}
	</select>
</mapper>
