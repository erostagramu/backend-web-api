<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.jleague.club.api.dao.masterdb.write.IJcJchallengeTicketWriteDAO">

	<resultMap type="jp.jleague.club.api.dao.masterdb.dto.IJcJchallengeTicketDTO" id="IJcJchallengeTicketDTO">
		<result column="jc_ticket_serial_number" property="jcTicketSerialNumber" javaType="java.lang.Integer" />
		<result column="game_id" property="gameId" javaType="java.lang.Integer" />
		<result column="pia_campaign_code" property="piaCampaignCode" javaType="java.lang.String" />
		<result column="pia_campaign_name" property="piaCampaignName" javaType="java.lang.String" />
		<result column="pia_serial_id" property="piaSerialId" javaType="java.lang.String" />
		<result column="for_purchase_url" property="forPurchaseUrl" javaType="java.lang.String" />
		<result column="receptionist_start_datetime" property="receptionistStartDatetime" javaType="java.util.Date" />
		<result column="receptionist_end_datetime" property="receptionistEndDatetime" javaType="java.util.Date" />
		<result column="file_record_make_datetime" property="fileRecordMakeDatetime" javaType="java.util.Date" />
		<result column="promo_code" property="promoCode" javaType="java.lang.String" />
		<result column="promo_code_get_member_id" property="promoCodeGetMemberId" javaType="java.lang.String" />
		<result column="promo_code_issue_datetime" property="promoCodeIssueDatetime" javaType="java.util.Date" />
		<result column="promo_code_use_limit_date" property="promoCodeUseLimitDate" javaType="java.util.Date" />
		<result column="promo_code_use_member_id" property="promoCodeUseMemberId" javaType="java.lang.String" />
		<result column="promo_code_use_datetime" property="promoCodeUseDatetime" javaType="java.util.Date" />
		<result column="jchallenge_ticket_status" property="jchallengeTicketStatus" javaType="java.lang.Integer" />
		<result column="acceptance_kind_id" property="acceptanceKindId" javaType="java.lang.Integer" />
		<result column="acceptance_name" property="acceptanceName" javaType="java.lang.String" />
		<result column="acceptance_name_kana" property="acceptanceNameKana" javaType="java.lang.String" />
		<result column="acceptance_postal_code" property="acceptancePostalCode" javaType="java.lang.String" />
		<result column="acceptance_address_1" property="acceptanceAddress1" javaType="java.lang.String" />
		<result column="acceptance_address_2" property="acceptanceAddress2" javaType="java.lang.String" />
		<result column="acceptance_address_3" property="acceptanceAddress3" javaType="java.lang.String" />
		<result column="acceptance_address_4" property="acceptanceAddress4" javaType="java.lang.String" />
		<result column="acceptance_tel" property="acceptanceTel" javaType="java.lang.String" />
		<result column="acceptance_seat_type" property="acceptanceSeatType" javaType="java.lang.String" />
		<result column="ticket_provider" property="ticketProvider" javaType="java.lang.String" />
		<result column="delete_flg" property="deleteFlg" javaType="java.lang.Integer" />
		<result column="regist_datetime" property="registDatetime" javaType="java.util.Date" />
		<result column="update_datetime" property="updateDatetime" javaType="java.util.Date" />
	</resultMap>

<update id="updatePcodeTemporaryHolding" parameterType="jp.jleague.club.api.dao.masterdb.dto.IJchallengeTicketDTO">
update 
	i_jc_jchallenge_ticket
set
	 promo_code = #{promoCode}
    ,promo_code_get_member_id = #{promoCodeGetMemberId}
    ,promo_code_issue_datetime = #{promoCodeIssueDatetime}
    ,promo_code_use_limit_date = #{promoCodeUseLimitDate}
    ,promo_code_use_member_id = #{promoCodeUseMemberId}
    ,promo_code_use_datetime = #{promoCodeUseDatetime}
   	,jchallenge_ticket_status = 2
    ,delete_flg = #{deleteFlg}
    ,update_datetime = #{updateDatetime}
where
		game_id = #{gameId}
	AND pickup_flg = #{pickupFlg}
	AND #{receptionistStartDatetime} between receptionist_start_datetime AND receptionist_end_datetime
	AND jchallenge_ticket_status = 1
limit 1
</update>

	<select id="selectJcallengeTicketByPromoCode" parameterType="java.lang.String" resultMap="IJcJchallengeTicketDTO">
		select
			jc_ticket_serial_number,
			game_id,
			pia_campaign_code,
			pia_campaign_name,
			pia_serial_id,
			for_purchase_url,
			receptionist_start_datetime,
			receptionist_end_datetime,
			file_record_make_datetime,
			promo_code,
			promo_code_get_member_id,
			promo_code_issue_datetime,
			promo_code_use_limit_date,
			promo_code_use_member_id,
			promo_code_use_datetime,
			jchallenge_ticket_status,
			acceptance_kind_id,
			acceptance_name,
			acceptance_name_kana,
			acceptance_postal_code,
			acceptance_address_1,
			acceptance_address_2,
			acceptance_address_3,
			acceptance_address_4,
			acceptance_tel,
			acceptance_seat_type,
			ticket_provider,
			delete_flg,
			regist_datetime,
			update_datetime
		from i_jc_jchallenge_ticket
		where promo_code = #{promoCode}
	</select>

	<update id="updateJchallengeTicketMailingAddress" parameterType="jp.jleague.club.api.dao.masterdb.dto.IJcJchallengeTicketDTO">
		update i_jc_jchallenge_ticket
		<set>
		acceptance_name = #{acceptanceName},
		acceptance_name_kana = #{acceptanceNameKana},
		acceptance_postal_code = #{acceptancePostalCode},
		acceptance_address_1 = #{acceptanceAddress1},
		acceptance_address_2 = #{acceptanceAddress2},
		acceptance_address_3 = #{acceptanceAddress3},
		acceptance_address_4 = #{acceptanceAddress4},
		acceptance_tel = #{acceptanceTel},
		update_datetime = #{updateDatetime}
		</set>
		where jc_ticket_serial_number = #{jcTicketSerialNumber}
	</update>
	
	<update id="updateMakeTicketUsed">
	update
		i_jc_jchallenge_ticket
	set
		 promo_code_use_member_id = #{promoCodeUseMemberId}
        ,promo_code_use_datetime = #{promoCodeUseDatetime}
		,jchallenge_ticket_status = #{jchallengeTicketStatus}
		,update_datetime = #{updateDatetime}
	where
		promo_code = #{promoCode}
	</update>
	
	<select id="selectAcceptanceKindAndUrl" parameterType="jp.jleague.club.api.dao.masterdb.dto.IJchallengeTicketDTO" resultMap="IJcJchallengeTicketDTO">
	select
		acceptance_kind_id,
		for_purchase_url
	from
		i_jc_jchallenge_ticket
	where
		promo_code = #{promoCode}
	</select>
	
		
	<select id="selectJcExpiredCountCheck" parameterType="jp.jleague.club.api.dao.masterdb.dto.IJchallengeTicketDTO" resultType="java.lang.Integer">
		select
			count(*)
		from 
			i_jc_jchallenge_ticket
	    where	
	    		promo_code = #{promoCode}
			and receptionist_end_datetime >= date(#{receptionistEndDatetime})	
	</select>
	
	<select id="selectStatusCountCheck" parameterType="jp.jleague.club.api.dao.masterdb.dto.IJchallengeTicketDTO" resultType="java.lang.Integer">
		select
			count(*)
		from
			i_jc_jchallenge_ticket
		where
				promo_code = #{promoCode}
			and jchallenge_ticket_status = #{jchallengeTicketStatus}
	</select>
	
</mapper>
