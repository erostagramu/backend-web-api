<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.jleague.club.api.dao.masterdb.read.IJchallengeTicketInvitationCodeWriteDAO">

<select id="selectNewPromosionCode" parameterType="jp.jleague.club.api.dao.masterdb.dto.IJchallengeTicketInvitationCodeDTO" resultType="java.lang.Integer">
	select 
		count(*)
	from
		i_jc_promo_code
	where
		    promo_code_get_member_id = #{promoCodeGetMemberId}
		and promo_code_use_member_id is null
		and #{registDatetime} between promo_code_issue_datetime and promo_code_use_limit_date
		and game_id = #{gameId}
</select>

<insert id="insertNewPromosionCode" parameterType="jp.jleague.club.api.dao.masterdb.dto.IJchallengeTicketInvitationCodeDTO">
INSERT INTO i_jc_promo_code
	(
	  promo_code
	, promo_code_get_member_id
	, promo_code_issue_datetime
	, promo_code_use_limit_date
	, promo_code_use_member_id
	, promo_code_use_datetime
	, game_id
	, delete_flg
	, regist_datetime
	, update_datetime
	) VALUES (
	  #{promoCode}
	, #{promoCodeGetMemberId}
	, #{promoCodeIssueDatetime}
	, #{promoCodeUseLimitDate}
	, #{promoCodeUseMemberId}
	, #{promoCodeUseDatetime}
	, #{gameId}
	, #{deleteFlg}
	, #{registDatetime}
	, #{updateDatetime}
	)
</insert>

<update id="updateUsingPromoCode" parameterType="jp.jleague.club.api.dao.masterdb.dto.IJchallengeTicketInvitationCodeDTO">
	update
		i_jc_promo_code
	set
		 promo_code_use_member_id = #{promoCodeUseMemberId}
    	,promo_code_use_datetime = #{promoCodeUseDatetime}
    	,update_datetime = #{updateDatetime}
	where
		promo_code = #{promoCode}
</update>

<select id="selectMemberIdCountCheck" resultType="java.lang.Integer">
	select 
		count(*)
	from
		i_jc_promo_code
	where
		promo_code_use_member_id = #{memberId}
</select>

<select id="selectConsumptionCheck" parameterType="jp.jleague.club.api.dao.masterdb.dto.IJchallengeTicketInvitationCodeDTO"  resultType="java.lang.Integer">
	select 
		count(*)
	from 
		i_jc_promo_code
	where
			promo_code_use_member_id = #{promoCodeUseMemberId}
		and promo_code = #{promoCode}
		and promo_code_use_datetime is not null
</select>

<select id="selectExpiredCountCheck" parameterType="jp.jleague.club.api.dao.masterdb.dto.IJchallengeTicketInvitationCodeDTO" resultType="java.lang.Integer" >
	select
		count(*)
	from
		i_jc_promo_code
	where
			promo_code = #{promoCode}
		and promo_code_use_limit_date >= #{promoCodeUseLimitDate}
	order by
		update_datetime DESC
	limit 1
</select>

</mapper> 
